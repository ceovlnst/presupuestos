<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Presupuestos quir√∫rgicos H9O</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f6f9;
      color: #1f2933;
    }
    .layout {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      max-width: 960px;
      width: 100%;
      padding: 24px 32px 28px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 32px;
    }
    @media (max-width: 800px) {
      .card {
        grid-template-columns: 1fr;
        padding: 20px;
      }
    }
    .card-left {
      border-right: 1px solid #e5e7eb;
      padding-right: 24px;
    }
    @media (max-width: 800px) {
      .card-left {
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
        padding-right: 0;
        padding-bottom: 20px;
      }
    }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 4px;
      color: #0054a6;
    }
    h2 {
      font-size: 1rem;
      font-weight: 500;
      margin: 0;
      color: #6b7280;
    }
    .hospital-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e6f0ff;
      color: #003b80;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-top: 10px;
    }
    .hospital-tag-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #0054a6;
    }
    .subtitle {
      margin-top: 18px;
      font-size: 0.9rem;
      color: #4b5563;
      line-height: 1.5;
    }
    .info-list {
      margin-top: 16px;
      padding-left: 18px;
      font-size: 0.9rem;
      color: #374151;
    }
    .info-list li {
      margin-bottom: 4px;
    }
    .small-note {
      margin-top: 12px;
      font-size: 0.78rem;
      color: #6b7280;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.75rem;
      background-color: #e5e7eb;
      color: #374151;
      margin-left: 6px;
    }

    .seccion {
      margin-top: 8px;
    }
    .seccion-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 6px;
    }
    .seccion-desc {
      font-size: 0.82rem;
      color: #6b7280;
      margin-bottom: 10px;
    }

    
    .subcard-material {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 10px 12px;
      margin-top: 8px;
    }
    .subcard-material-header {
      font-size: 0.8rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    .subcard-material-body {
      font-size: 0.8rem;
    }
    .fila-busqueda-material {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .lista-materiales {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .item-material {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.78rem;
      transition: background-color 0.15s ease, border-color 0.15s ease;
    }
    .item-material:hover {
      border-color: #0054a6;
      background: #eef2ff;
    }
    .item-material-nombre {
      font-weight: 500;
      color: #111827;
    }
    .item-material-detalle {
      color: #6b7280;
      font-size: 0.75rem;
      margin-top: 2px;
    }
    .item-material.vacio {
      cursor: default;
      background: #f3f4f6;
      border-style: dashed;
    }
    .fila-seleccion-material {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      flex-wrap: wrap;
      font-size: 0.8rem;
    }

    .subcard-cirujano {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 10px 12px;
      margin-top: 8px;
    }
    .subcard-cirujano-header {
      font-size: 0.8rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    .subcard-cirujano-body {
      font-size: 0.8rem;
    }
    .lista-cirujanos {
      max-height: 180px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }
    .item-cirujano {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.78rem;
      transition: background-color 0.15s ease, border-color 0.15s ease;
    }
    .item-cirujano:hover {
      border-color: #0054a6;
      background: #eef2ff;
    }
    .item-cirujano-nombre {
      font-weight: 500;
      color: #111827;
    }
    .item-cirujano-detalle {
      color: #6b7280;
      font-size: 0.75rem;
      margin-top: 2px;
    }
    .item-cirujano.vacio {
      cursor: default;
      background: #f3f4f6;
      border-style: dashed;
    }
    .fila-seleccion-cirujano {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
      flex-wrap: wrap;
      font-size: 0.8rem;
    }
.panel {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      margin-top: 12px;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      cursor: pointer;
    }
    .panel-header-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #111827;
    }
    .panel-body {
      padding: 8px 10px 12px;
      border-top: 1px solid #e5e7eb;
      display: none;
    }
    .panel-arrow {
      font-size: 0.9rem;
      color: #6b7280;
    }

.oculto {
      display: none;
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 0.8rem;
      color: #4b5563;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      margin-top: 2px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #0054a6;
      box-shadow: 0 0 0 1px rgba(2,132,199,0.25);
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .btn-primary {
      background: #0054a6;
      color: #ffffff;
    }
    .btn-primary:hover {
      background: #003b80;
    }
    .btn-ghost {
      background: transparent;
      color: #0054a6;
    }
    .btn-ghost:hover {
      background: #f3f4f6;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
    }
    .message-ok {
      color: #15803d;
    }
    .message-error {
      color: #b91c1c;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 0.8rem;
    }

    .tabla-scroll {
      width: 100%;
      overflow-x: auto;
    }

    .tabla-scroll table {
      min-width: 100%;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
    }

    
    .estado-borrador {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f97316;
      color: #ffffff;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .estado-confirmado {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #16a34a;
      color: #ffffff;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .texto-secundario {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .dialog-actions-inline {
      margin-top: 12px;
      margin-bottom: 12px;
      text-align: right;
    }
.tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .tab-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #0054a6;
      color: white;
      border-color: #0054a6;
    }
  
    .dialog-overlay {
      
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
        .dialog-overlay.activo {
      display: flex;
    }
    .dialog {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.35);
      max-width: 720px;
      width: calc(100% - 32px);
      max-height: 80vh;
      padding: 20px 24px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .dialog-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }
    .dialog-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .dialog-close-btn {
      border: none;
      background: transparent;
      font-size: 0.9rem;
      cursor: pointer;
      color: #4b5563;
    }
    .dialog-close-btn:hover {
      color: #111827;
    }
    .dialog-body {
      font-size: 0.8rem;
      color: #374151;
      overflow: auto;
      padding-top: 4px;
      border-top: 1px solid #e5e7eb;
    }
    .dialog-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 6px 14px;
      margin-bottom: 10px;
    }
    .dialog-summary-item-label {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .dialog-summary-item-value {
      font-size: 0.85rem;
      font-weight: 500;
      color: #111827;
    }
    .dialog-footer {
      margin-top: 10px;
      text-align: right;
    }

    /* ===== LOADING OVERLAY ===== */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .spinner-box {
      background: white;
      padding: 20px 28px;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 0.9rem;
      color: #0054a6;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 3px solid #e5e7eb;
      border-top: 3px solid #0054a6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }


    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f6f9;
      color: #1f2933;
    }
    .layout {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      max-width: 960px;
      width: 100%;
      padding: 24px 32px 28px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 32px;
    }
    @media (max-width: 800px) {
      .card {
        grid-template-columns: 1fr;
        padding: 20px;
      }
    }
    .card-left {
      border-right: 1px solid #e5e7eb;
      padding-right: 24px;
    }
    @media (max-width: 800px) {
      .card-left {
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
        padding-right: 0;
        padding-bottom: 20px;
      }
    }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 4px;
      color: #0b3c5d;
    }
    h2 {
      font-size: 1rem;
      font-weight: 500;
      margin: 0;
      color: #6b7280;
    }
    .hospital-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0f2fe;
      color: #075985;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-top: 10px;
    }
    .hospital-tag-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #0284c7;
    }
    .subtitle {
      margin-top: 18px;
      font-size: 0.9rem;
      color: #4b5563;
      line-height: 1.5;
    }
    .info-list {
      margin-top: 16px;
      padding-left: 18px;
      font-size: 0.9rem;
      color: #374151;
    }
    .info-list li {
      margin-bottom: 4px;
    }
    .small-note {
      margin-top: 12px;
      font-size: 0.78rem;
      color: #6b7280;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.75rem;
      background-color: #e5e7eb;
      color: #374151;
      margin-left: 6px;
    }

    .seccion {
      margin-top: 8px;
    }
    .seccion-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 6px;
    }
    .seccion-desc {
      font-size: 0.82rem;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .panel {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      margin-top: 12px;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      cursor: pointer;
    }
    .panel-header-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #111827;
    }
    .panel-body {
      padding: 8px 10px 12px;
      border-top: 1px solid #e5e7eb;
      display: none;
    }
    .panel-arrow {
      font-size: 0.9rem;
      color: #6b7280;
    }

.oculto {
      display: none;
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 0.8rem;
      color: #4b5563;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      margin-top: 2px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #0284c7;
      box-shadow: 0 0 0 1px rgba(2,132,199,0.25);
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .btn-primary {
      background: #0b3c5d;
      color: #ffffff;
    }
    .btn-primary:hover {
      background: #064165;
    }
    .btn-ghost {
      background: transparent;
      color: #0b3c5d;
    }
    .btn-ghost:hover {
      background: #f3f4f6;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
    }
    .message-ok {
      color: #15803d;
    }
    .message-error {
      color: #b91c1c;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 0.8rem;
    }

    .tabla-scroll {
      width: 100%;
      overflow-x: auto;
    }

    .tabla-scroll table {
      min-width: 100%;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
    }

    
    .estado-borrador {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f97316;
      color: #ffffff;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .estado-confirmado {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #16a34a;
      color: #ffffff;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .texto-secundario {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .dialog-actions-inline {
      margin-top: 12px;
      margin-bottom: 12px;
      text-align: right;
    }
.tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .tab-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #0b3c5d;
      color: white;
      border-color: #0b3c5d;
    }
  
    .dialog-overlay {
      
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
        .dialog-overlay.activo {
      display: flex;
    }
    .dialog {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.35);
      max-width: 720px;
      width: calc(100% - 32px);
      max-height: 80vh;
      padding: 20px 24px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .dialog-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }
    .dialog-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .dialog-close-btn {
      border: none;
      background: transparent;
      font-size: 0.9rem;
      cursor: pointer;
      color: #4b5563;
    }
    .dialog-close-btn:hover {
      color: #111827;
    }
    .dialog-body {
      font-size: 0.8rem;
      color: #374151;
      overflow: auto;
      padding-top: 4px;
      border-top: 1px solid #e5e7eb;
    }
    .dialog-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 6px 14px;
      margin-bottom: 10px;
    }
    .dialog-summary-item-label {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .dialog-summary-item-value {
      font-size: 0.85rem;
      font-weight: 500;
      color: #111827;
    }
    .dialog-footer {
      margin-top: 10px;
      text-align: right;
    }

    /* ===== LOADING OVERLAY ===== */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .spinner-box {
      background: white;
      padding: 20px 28px;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 0.9rem;
      color: #0b3c5d;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 3px solid #e5e7eb;
      border-top: 3px solid #0b3c5d;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

</style>
</head>
<body>
  <div class="layout">
    <div class="card">
      <!-- LADO IZQUIERDO -->
      <div class="card-left">
        <h1>Gestor de presupuestos quir√∫rgicos</h1>
        <h2>Traumatolog√≠a y cirug√≠a ortop√©dica</h2>
        <div class="hospital-tag">
          <div class="hospital-tag-dot"></div>
          Entorno interno hospitalario
        </div>

        <p class="subtitle">
          Esta herramienta est√° dise√±ada para que cada cirujano pueda estructurar los
          materiales, honorarios y estancias de sus cirug√≠as sin visualizar el coste
          econ√≥mico de los implantes. El control de costes y los informes detallados
          quedan restringidos al perfil gestor.
        </p>

        <ul class="info-list">
          <li>Los cirujanos configuran uno o varios presupuestos por tipo de cirug√≠a.</li>
          <li>El gestor visualiza el impacto econ√≥mico y genera informes por cirujano.</li>
          <li>El acceso se realiza con email y contrase√±a espec√≠ficos del sistema.</li>
        </ul>

        <p class="small-note" id="infoUsuario">
          Introduce tus credenciales o solicita el alta para comenzar.
        </p>
      </div>

      <!-- LADO DERECHO -->
      <div>
        <!-- Pesta√±as -->
        <div class="tabs">
          <button id="tabLogin" class="tab-btn active" type="button" onclick="mostrarPanel('login')">
            Acceso
          </button>
          <button id="tabAlta" class="tab-btn" type="button" onclick="mostrarPanel('alta')">
            Solicitar alta
          </button>
        </div>

        <!-- LOGIN -->
        <div id="panelLogin" class="seccion">
          <div class="seccion-title">Acceso al sistema</div>
          <div class="seccion-desc">
            Introduce tu email y contrase√±a para acceder. El rol y la activaci√≥n se gestionan desde administraci√≥n.
          </div>

          <label>Email</label>
          <input type="email" id="loginEmail">

          <label>Contrase√±a</label>
          <input type="password" id="loginPassword">

          <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button class="btn-primary" type="button" onclick="hacerLogin()">Entrar</button>
            <button class="btn-ghost" type="button" onclick="pedirResetPassword()" style="font-size:0.75rem;">
              He olvidado mi contrase√±a
            </button>
          </div>
          <div id="loginMensaje" class="message"></div>
        </div>

        <!-- ALTA -->
        <div id="panelAlta" class="seccion oculto">
          <div class="seccion-title">Solicitud de alta</div>
          <div class="seccion-desc">
            Rellena todos los campos para solicitar el alta. Por defecto todos los usuarios se registran como cirujanos; si procede, el administrador podr√° cambiar el perfil a gestor.
          </div>

          <label>Email</label>
          <input type="email" id="alta_email">

          <label>Nombre completo</label>
          <input type="text" id="alta_nombre">

          <label>Servicio / Unidad</label>
          <input type="text" id="alta_servicio">

          <label>Contrase√±a</label>
          <input type="password" id="alta_password">

          <label>Repite la contrase√±a</label>
          <input type="password" id="alta_password2">

          <button class="btn-primary" type="button" onclick="enviarAlta()">Solicitar alta</button>
          <div id="altaMensaje" class="message"></div>
        </div>

        <!-- CIRUJANO: NUEVO PRESUPUESTO -->
        <div id="zonaCirujano" class="seccion oculto panel">
          <div class="panel-header" onclick="togglePanel('zonaCirujano')">
            <span class="panel-header-title">Nuevo presupuesto</span>
            <span class="panel-arrow" id="arrow-zonaCirujano">‚ñº</span>
          </div>
          <div class="panel-body" id="body-zonaCirujano">
          <div class="seccion-desc">
            Define el tipo de cirug√≠a, los honorarios y las estancias, y selecciona los
            implantes o materiales necesarios. El valor econ√≥mico solo ser√° visible para el perfil gestor.
          </div>

          <label>Nombre del presupuesto</label>
          <input id="pres_nombre" type="text">

          <div id="pres_campoCirujanoAsignado" class="oculto">
            <div class="subcard-cirujano">
              <div class="subcard-cirujano-header">Asignar presupuesto a cirujano</div>
              <div class="subcard-cirujano-body">
                <div>
                  <label style="font-size:0.8rem;">Buscar cirujano</label>
                  <input id="filtro_cirujano" type="text" style="width:100%; box-sizing:border-box; margin-top:4px;" placeholder="Nombre, email o servicio">
                </div>
                <div class="lista-cirujanos" id="lista_cirujanos_resultados"></div>
                <div class="fila-seleccion-cirujano">
                  <span style="font-size:0.8rem;">Cirujano seleccionado:</span>
                  <div id="pres_cirujanoSeleccionado_texto" style="flex:1 1 auto; padding:4px 8px; border-radius:8px; border:1px solid #d1d5db; background:#f9fafb;">
                    Ninguno (se usar√° el propio usuario)
                  </div>
                  <select id="pres_cirujanoAsignado" style="display:none;"></select>
                </div>
              </div>
            </div>
          </div>

          <label>Honorarios m√©dicos (‚Ç¨)</label>
          <input id="pres_honor" type="number" step="0.01">
<h4 style="margin-top:14px; font-size:0.9rem;">Materiales</h4>

          <div class="subcard-material">
            <div class="subcard-material-header">Buscar materiales</div>
            <div class="subcard-material-body">
              <div class="fila-busqueda-material">
                <div style="flex:1 1 0;">
                  <label style="font-size:0.8rem;">Texto (producto o proveedor)</label>
                  <input id="filtro_producto" type="text" list="lista_productos" style="width:100%; box-sizing:border-box; margin-top:4px;">
                  <datalist id="lista_productos"></datalist>
                </div>
                <div style="flex:1 1 0;">
                  <label style="font-size:0.8rem;">Proveedor</label>
                  <input id="filtro_proveedor_texto" type="text" list="lista_proveedores" style="width:100%; box-sizing:border-box; margin-top:4px;">
                  <datalist id="lista_proveedores"></datalist>
                </div>
                <div>
                  <button class="btn-ghost" type="button" onclick="filtrarProductos()" style="white-space:nowrap; margin-top:4px;">Buscar</button>
                </div>
              </div>
            </div>
          </div>

          <div class="subcard-material" style="margin-top:8px;">
            <div class="subcard-material-header">Resultados de la b√∫squeda</div>
            <div class="subcard-material-body">
              <div id="lista_productos_resultados" class="lista-materiales"></div>
            </div>
          </div>

          <div class="fila-seleccion-material">
            <label style="font-size:0.8rem;">Material seleccionado</label>
            <div id="sel_producto_texto" style="flex:1 1 auto; padding:6px 8px; border-radius:8px; border:1px solid #d1d5db; background:#f9fafb; font-size:0.85rem; color:#111827;">
              Ning√∫n material seleccionado
            </div>
            <select id="sel_producto" style="display:none;"></select>
            <input id="prod_cantidad" type="number" value="1" min="1" style="width:80px;">
            <button class="btn-ghost" type="button" onclick="agregarLinea()">A√±adir</button>
          </div>

<table id="tabla_lineas">
            <thead>
              <tr><th>Producto</th><th>Cantidad</th><th>Acci√≥n</th></tr>
            </thead>
            <tbody></tbody>
          </table>

          <button class="btn-primary" type="button" onclick="guardarPresupuesto()">Guardar presupuesto</button>
          <div id="msgGuardar" class="message"></div>
          </div>
        </div>

        <!-- CIRUJANO: MIS PRESUPUESTOS -->
        <div id="zonaMisPresupuestos" class="seccion oculto panel">
          <div class="panel-header" onclick="togglePanel('zonaMisPresupuestos')">
            <span class="panel-header-title">Mis presupuestos</span>
            <span class="panel-arrow" id="arrow-zonaMisPresupuestos">‚ñº</span>
          </div>
          <div class="panel-body" id="body-zonaMisPresupuestos">
          <div class="seccion-desc">
            Listado de presupuestos asociados a tu usuario. El detalle econ√≥mico completo se gestiona desde el perfil de administraci√≥n.
          </div>
          <div id="listaMisPresupuestos"></div>
          </div>
        </div>

        <!-- ADMIN -->
        <div id="zonaAdmin" class="seccion oculto panel">
          <div class="panel-header" onclick="togglePanel('zonaAdmin')">
            <span class="panel-header-title">Vista gestor / administraci√≥n</span>
            <span class="panel-arrow" id="arrow-zonaAdmin">‚ñº</span>
          </div>
          <div class="panel-body" id="body-zonaAdmin">
          <div class="seccion-desc">
            Resumen de presupuestos con coste de materiales y total econ√≥mico por cirujano.
          </div>

          <label style="margin-top:8px; font-size:0.8rem;">Buscar cirujano</label>
          <div style="display:flex; gap:8px; align-items:center; margin-top:4px; flex-wrap:wrap;">
            <input id="admin_filtro_cirujano" type="text" placeholder="Nombre o email del cirujano">
            <button class="btn-ghost" type="button" onclick="buscarPresupuestosAdmin()" style="white-space:nowrap;">Buscar</button>
            <button class="btn-ghost" type="button" onclick="resetFiltroPresupuestosAdmin()" style="white-space:nowrap;">Limpiar</button>
            <button class="btn-ghost" type="button" onclick="verTodosBorradoresAdmin()" style="white-space:nowrap;">Ver todos los borradores</button>
          </div>

          <div id="listaPresupuestosAdmin" style="margin-top:10px;">Introduce un nombre o email de cirujano y pulsa Buscar.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="dialogPresupuestoOverlay" class="dialog-overlay" onclick="cerrarDialogoPresupuesto()">
    <div class="dialog" onclick="event.stopPropagation()">
      <div class="dialog-header">
        <div>
          <div class="dialog-title">Detalle de presupuesto</div>
          <div class="dialog-subtitle">Resumen econ√≥mico y materiales incluidos</div>
        </div>
        <button class="dialog-close-btn" type="button" onclick="cerrarDialogoPresupuesto()">Cerrar ‚úï</button>
      </div>
      <div id="dialogPresupuestoContenido" class="dialog-body">
      </div>
      <div class="dialog-footer">
        <button class="btn-primary" type="button" onclick="cerrarDialogoPresupuesto()">Cerrar</button>
      </div>
    </div>
  </div>


  <script>
    // üî¥ IMPORTANTE: pon aqu√≠ la URL de tu web app de Apps Script (la que termina en /exec)
    const GAS_URL = "https://presupuestosh9o.ceo-vlnst.workers.dev/";

    let usuarioActual = null; // {email, password, rol, nombre, servicio}
    let productosCache = [];
    let lineasCarrito = [];
    let usuariosActivosCache = [];
    let listaPresupuestosAdminCache = [];
    let presupuestoEnEdicionId = null;



    function initFiltroCirujano() {
      const input = document.getElementById("filtro_cirujano");
      if (input) {
        input.addEventListener("input", () => {
          renderizarListaCirujanos();
        });
      }
    }
    // Funci√≥n gen√©rica para llamar a la API de GAS
    
    function showLoading() {
      const overlay = document.getElementById("loadingOverlay");
      if (overlay) overlay.style.display = "flex";
    }

    function hideLoading() {
      const overlay = document.getElementById("loadingOverlay");
      if (overlay) overlay.style.display = "none";
    }

    async function apiCall(action, data) {
      showLoading();
      try {
        const resp = await fetch(GAS_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ action, data })
        });

        const json = await resp.json();
        if (!json.ok) {
          throw new Error(json.error || "Error desconocido en servidor");
        }
        return json.result;
      } finally {
        hideLoading();
      }
    }


      // Normaliza texto: min√∫sculas y sin tildes para comparaciones relajadas
    function normalizarTexto(str) {
      return (str || "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function mostrarPanel(tipo) {
      const panelLogin = document.getElementById("panelLogin");
      const panelAlta  = document.getElementById("panelAlta");
      const tabLogin   = document.getElementById("tabLogin");
      const tabAlta    = document.getElementById("tabAlta");

      if (tipo === "login") {
        panelLogin.classList.remove("oculto");
        panelAlta.classList.add("oculto");
        tabLogin.classList.add("active");
        tabAlta.classList.remove("active");
      } else {
        panelLogin.classList.add("oculto");
        panelAlta.classList.remove("oculto");
        tabLogin.classList.remove("active");
        tabAlta.classList.add("active");
      }
    }


    function togglePanel(id) {
      const body = document.getElementById("body-" + id);
      const arrow = document.getElementById("arrow-" + id);
      if (!body) return;
      const isHidden = body.style.display === "" || body.style.display === "none";
      body.style.display = isHidden ? "block" : "none";
      if (arrow) {
        arrow.textContent = isHidden ? "‚ñ≤" : "‚ñº";
      }
    }

    // === ALTA ===
    async function enviarAlta() {
      const email    = (document.getElementById("alta_email").value || "").trim();
      const nombre   = (document.getElementById("alta_nombre").value || "").trim();
      const servicio = (document.getElementById("alta_servicio").value || "").trim();
      const pwd1     = document.getElementById("alta_password").value;
      const pwd2     = document.getElementById("alta_password2").value;
      const msgDiv   = document.getElementById("altaMensaje");

      msgDiv.textContent = "";
      msgDiv.className = "message";

      if (!email || !nombre || !servicio || !pwd1 || !pwd2) {
        msgDiv.textContent = "Debes rellenar todos los campos.";
        msgDiv.classList.add("message-error");
        return;
      }
      if (pwd1 !== pwd2) {
        msgDiv.textContent = "Las contrase√±as no coinciden.";
        msgDiv.classList.add("message-error");
        return;
      }

      try {
        const res = await apiCall("altaUsuario", {
          email,
          nombre,
          rol: "CIRUJANO",
          servicio,
          password: pwd1
        });
        msgDiv.textContent = res.mensaje || "Solicitud enviada.";
        msgDiv.classList.add("message-ok");
      } catch (err) {
        hideLoading();
        msgDiv.textContent = "Error: " + err.message;
        msgDiv.classList.add("message-error");
      }
    }

    // === LOGIN ===
    async function hacerLogin() {
      const email = (document.getElementById("loginEmail").value || "").trim();
      const pwd   = document.getElementById("loginPassword").value;
      const msgDiv = document.getElementById("loginMensaje");
      const infoP  = document.getElementById("infoUsuario");

      msgDiv.textContent = "";
      msgDiv.className = "message";

      if (!email || !pwd) {
        msgDiv.textContent = "Introduce email y contrase√±a.";
        msgDiv.classList.add("message-error");
        return;
      }

      try {
        const res = await apiCall("login", { email, password: pwd });

        usuarioActual = {
          email: res.email,
          password: pwd,
          rol: res.rol,
          nombre: res.nombre,
          servicio: res.servicio
        };
        msgDiv.textContent = "Acceso correcto.";
        msgDiv.classList.add("message-ok");

        let texto = "Usuario: " + (res.nombre || res.email);
        if (res.rol) texto += " (" + res.rol + ")";
        if (res.servicio) texto += " ¬∑ " + res.servicio;
        infoP.textContent = texto;

        // Mostrar zonas
        document.getElementById("panelLogin").classList.add("oculto");
        document.getElementById("panelAlta").classList.add("oculto");
        document.getElementById("tabLogin").classList.add("oculto");
        document.getElementById("tabAlta").classList.add("oculto");

        if (res.rol === "CIRUJANO" || res.rol === "ADMIN") {
          document.getElementById("zonaCirujano").classList.remove("oculto");
          document.getElementById("zonaMisPresupuestos").classList.remove("oculto");
          cargarProductos();
          cargarMisPresupuestos();

          if (res.rol === "CIRUJANO") {
            togglePanel('zonaCirujano');
            togglePanel('zonaMisPresupuestos');
          }
        }

        if (res.rol === "ADMIN") {
          document.getElementById("zonaAdmin").classList.remove("oculto");
          // No cargamos los presupuestos a√∫n; solo cuando el gestor pulse "Buscar".
          cargarUsuariosActivos();
        }
      } catch (err) {
        hideLoading();
        msgDiv.textContent = err.message;
        msgDiv.classList.add("message-error");
      }
    }

    // === RESET PASSWORD ‚Üí BORRA USUARIO ===
    async function pedirResetPassword() {
      const email = (document.getElementById("loginEmail").value || "").trim();
      const msgDiv = document.getElementById("loginMensaje");

      msgDiv.textContent = "";
      msgDiv.className = "message";

      if (!email) {
        msgDiv.textContent = "Introduce tu email y luego pulsa en 'He olvidado mi contrase√±a'.";
        msgDiv.classList.add("message-error");
        return;
      }

      try {
        const res = await apiCall("solicitarResetPassword", { email });
        msgDiv.textContent = res.mensaje ||
          "Si el email existe en el sistema, se ha eliminado el usuario asociado y deber√°s solicitar el alta de nuevo.";
        msgDiv.classList.add("message-ok");
      } catch (err) {
        hideLoading();
        msgDiv.textContent = "No se ha podido procesar la solicitud. Int√©ntalo de nuevo m√°s tarde.";
        msgDiv.classList.add("message-error");
      }
    }

    // === PRODUCTOS / CARRITO ===

    async function cargarProductos() {
      if (!usuarioActual) return;
      try {
        const productos = await apiCall("getProductos", {
          email: usuarioActual.email,
          password: usuarioActual.password
        });
        productosCache = productos || [];
        const sel = document.getElementById("sel_producto");
        const dlProductos = document.getElementById("lista_productos");
        const dlProveedores = document.getElementById("lista_proveedores");

        if (sel) sel.innerHTML = "";
        if (dlProductos) dlProductos.innerHTML = "";
        if (dlProveedores) dlProveedores.innerHTML = "";

        if (!productosCache || productosCache.length === 0) {
          if (sel) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "No hay productos configurados";
            sel.appendChild(opt);
          }
          return;
        }

        // Rellenar select de productos (lista filtrada inicial = todos)
        productosCache.forEach(p => {
          if (!sel) return;
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.nombre + (p.descripcion ? " (" + p.descripcion + ")" : "");
          sel.appendChild(opt);
        });

        // Rellenar datalist de productos para sugerencias de texto
        if (dlProductos) {
          const nombresUnicos = new Set();
          productosCache.forEach(p => {
            const nombre = (p.nombre || "").toString().trim();
            if (nombre) nombresUnicos.add(nombre);
          });
          Array.from(nombresUnicos).sort().forEach(nombre => {
            const opt = document.createElement("option");
            opt.value = nombre;
            dlProductos.appendChild(opt);
          });
        }

        // Rellenar datalist de proveedores
        if (dlProveedores) {
          const setProv = new Set();
          productosCache.forEach(p => {
            const prov = (p.descripcion || "").toString().trim();
            if (prov) setProv.add(prov);
          });
          Array.from(setProv).sort().forEach(prov => {
            const opt = document.createElement("option");
            opt.value = prov;
            dlProveedores.appendChild(opt);
          });
        }
      } catch (err) {
        hideLoading();
        alert("Error cargando productos: " + err.message);
      }
    }



    function filtrarProductos() {
      const sel = document.getElementById("sel_producto");
      const inputProd = document.getElementById("filtro_producto");
      const inputProv = document.getElementById("filtro_proveedor_texto");
      const contResultados = document.getElementById("lista_productos_resultados");
      if (!sel || !inputProd) return;

      const filtroTexto = (inputProd.value || "").toLowerCase();
      const filtroProv = (inputProv ? inputProv.value : "").toLowerCase();

      sel.innerHTML = "";
      if (contResultados) {
        contResultados.innerHTML = "";
      }

      if (!productosCache || productosCache.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No hay productos configurados";
        sel.appendChild(opt);

        if (contResultados) {
          const div = document.createElement("div");
          div.className = "item-material vacio";
          div.textContent = "No hay productos configurados";
          contResultados.appendChild(div);
        }
        return;
      }

      const listaFiltrada = productosCache.filter(p => {
        const nombre = (p.nombre || "").toString().toLowerCase();
        const prov = (p.descripcion || "").toString();
        const provLower = prov.toLowerCase();

        const textoCoincide =
          !filtroTexto ||
          nombre.includes(filtroTexto) ||
          provLower.includes(filtroTexto);

        const proveedorCoincide =
          !filtroProv ||
          provLower.includes(filtroProv);

        return textoCoincide && proveedorCoincide;
      });

      if (listaFiltrada.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Sin resultados para ese filtro";
        sel.appendChild(opt);

        if (contResultados) {
          const div = document.createElement("div");
          div.className = "item-material vacio";
          div.textContent = "Sin resultados para ese filtro";
          contResultados.appendChild(div);
        }
        return;
      }

      listaFiltrada.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre + (p.descripcion ? " (" + p.descripcion + ")" : "");
        sel.appendChild(opt);

        if (contResultados) {
          const item = document.createElement("div");
          item.className = "item-material";

          const nombreDiv = document.createElement("div");
          nombreDiv.className = "item-material-nombre";
          nombreDiv.textContent = p.nombre || "";

          const detalleDiv = document.createElement("div");
          detalleDiv.className = "item-material-detalle";
          detalleDiv.textContent = p.descripcion || "";

          item.appendChild(nombreDiv);
          item.appendChild(detalleDiv);

          item.addEventListener("click", () => {
            sel.value = p.id;
          
            const textoSel = document.getElementById("sel_producto_texto");
            if (textoSel) {
              textoSel.textContent = p.nombre + (p.descripcion ? " (" + p.descripcion + ")" : "");
            }
});

          contResultados.appendChild(item);
        }
      });
    }


// === USUARIOS ACTIVOS (solo ADMIN) ===
    
    async function cargarUsuariosActivos() {
      if (!usuarioActual) return;
      try {
        const lista = await apiCall("getUsuariosActivos", {
          email: usuarioActual.email,
          password: usuarioActual.password
        });
        usuariosActivosCache = lista || [];
        const cont = document.getElementById("pres_campoCirujanoAsignado");
        const sel = document.getElementById("pres_cirujanoAsignado");
        const listaDiv = document.getElementById("lista_cirujanos_resultados");
        const textoSel = document.getElementById("pres_cirujanoSeleccionado_texto");
        if (!sel || !cont || !listaDiv || !textoSel) return;

        sel.innerHTML = "";
        listaDiv.innerHTML = "";

        if (!usuariosActivosCache.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No hay usuarios activos";
          sel.appendChild(opt);

          const div = document.createElement("div");
          div.className = "item-cirujano vacio";
          div.textContent = "No hay usuarios activos";
          listaDiv.appendChild(div);

          cont.classList.remove("oculto");
        initFiltroCirujano();
          return;
        }

        const optVacio = document.createElement("option");
        optVacio.value = "";
        optVacio.textContent = "Usar el propio usuario";
        sel.appendChild(optVacio);

        usuariosActivosCache.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.email;
          const nombre = u.nombre || u.email;
          const servicio = u.servicio ? " ¬∑ " + u.servicio : "";
          opt.textContent = nombre + " (" + u.email + ")" + servicio;
          sel.appendChild(opt);
        });

        // Pintamos la lista inicial completa
        renderizarListaCirujanos();

        cont.classList.remove("oculto");
      } catch (err) {
        hideLoading();
        console.error("Error cargando usuarios activos:", err);
      }
    }

    function renderizarListaCirujanos() {
      const listaDiv = document.getElementById("lista_cirujanos_resultados");
      const sel = document.getElementById("pres_cirujanoAsignado");
      const filtroInput = document.getElementById("filtro_cirujano");
      const textoSel = document.getElementById("pres_cirujanoSeleccionado_texto");
      if (!listaDiv || !sel) return;

      listaDiv.innerHTML = "";

      const filtro = (filtroInput && filtroInput.value ? filtroInput.value : "").toLowerCase();

      if (!usuariosActivosCache || !usuariosActivosCache.length) {
        const div = document.createElement("div");
        div.className = "item-cirujano vacio";
        div.textContent = "No hay usuarios activos";
        listaDiv.appendChild(div);
        return;
      }

      const listaFiltrada = usuariosActivosCache.filter(u => {
        const nombre = (u.nombre || "").toLowerCase();
        const email = (u.email || "").toLowerCase();
        const servicio = (u.servicio || "").toLowerCase();
        if (!filtro) return true;
        return nombre.includes(filtro) || email.includes(filtro) || servicio.includes(filtro);
      });

      if (!listaFiltrada.length) {
        const div = document.createElement("div");
        div.className = "item-cirujano vacio";
        div.textContent = "Sin resultados para ese filtro";
        listaDiv.appendChild(div);
        return;
      }

      listaFiltrada.forEach(u => {
        const item = document.createElement("div");
        item.className = "item-cirujano";

        const nombreDiv = document.createElement("div");
        nombreDiv.className = "item-cirujano-nombre";
        nombreDiv.textContent = u.nombre || u.email;

        const detalleDiv = document.createElement("div");
        detalleDiv.className = "item-cirujano-detalle";
        const servicioTexto = u.servicio ? " ¬∑ " + u.servicio : "";
        detalleDiv.textContent = u.email + servicioTexto;

        item.appendChild(nombreDiv);
        item.appendChild(detalleDiv);

        item.addEventListener("click", () => {
          sel.value = u.email;
          if (textoSel) {
            textoSel.textContent = (u.nombre || u.email) + " (" + u.email + ")" + (u.servicio ? " ¬∑ " + u.servicio : "");
          }
        });

        listaDiv.appendChild(item);
      });
    }

// === GUARDAR PRESUPUESTO ===

    async function guardarPresupuesto() {
      if (!usuarioActual) return;

      const nombre = (document.getElementById("pres_nombre").value || "").trim();
      const honor = document.getElementById("pres_honor").value;
      const msgDiv = document.getElementById("msgGuardar");

      if (msgDiv) {
        msgDiv.textContent = "";
        msgDiv.className = "message";
      }

      if (!nombre) {
        if (msgDiv) {
          msgDiv.textContent = "Pon un nombre al presupuesto.";
          msgDiv.classList.add("message-error");
        }
        return;
      }
      if (lineasCarrito.length === 0) {
        if (msgDiv) {
          msgDiv.textContent = "A√±ade al menos un material.";
          msgDiv.classList.add("message-error");
        }
        return;
      }

      const datos = {
        nombre: nombre,
        honorarios: honor
      };

      const lineas = lineasCarrito.map(l => ({
        idProducto: l.idProducto,
        cantidad: l.cantidad
      }));

      let emailDestino = null;
      if (usuarioActual.rol === "ADMIN") {
        const selDestino = document.getElementById("pres_cirujanoAsignado");
        if (selDestino && selDestino.value) {
          emailDestino = selDestino.value;
        }
      }

      try {
        let res;
        if (presupuestoEnEdicionId) {
          // Actualizar presupuesto existente
          res = await apiCall("actualizarPresupuesto", {
            email: usuarioActual.email,
            password: usuarioActual.password,
            idPresupuesto: presupuestoEnEdicionId,
            datosPresupuesto: datos,
            lineas: lineas
          });
          if (res && res.ok === false) {
            throw new Error(res.error || "Error al actualizar");
          }
          if (msgDiv) {
            msgDiv.textContent = "Presupuesto actualizado (ID: " + presupuestoEnEdicionId + ").";
            msgDiv.classList.add("message-ok");
          }
        } else {
          // Crear nuevo presupuesto
          res = await apiCall("crearPresupuesto", {
            email: usuarioActual.email,
            password: usuarioActual.password,
            datosPresupuesto: datos,
            lineas: lineas,
            emailCirujanoDestino: emailDestino
          });
          if (res && res.ok === false) {
            throw new Error(res.error || "Error al guardar");
          }
          if (msgDiv) {
            msgDiv.textContent = "Presupuesto guardado (ID: " + res.idPresupuesto + ").";
            msgDiv.classList.add("message-ok");
          }
        }

        // Reset estado de edici√≥n y formulario
        presupuestoEnEdicionId = null;
        lineasCarrito = [];
        pintarTablaLineas();
        const campoNombre = document.getElementById("pres_nombre");
        const campoHonor = document.getElementById("pres_honor");
        if (campoNombre) campoNombre.value = "";
        if (campoHonor) campoHonor.value = "";
        cargarMisPresupuestos();
        if (usuarioActual.rol === "ADMIN") {
          // Refrescar tambi√©n la vista de administraci√≥n si procede
          buscarPresupuestosAdmin();
        }
      } catch (err) {
        hideLoading();
        if (msgDiv) {
          msgDiv.textContent = "Error: " + err.message;
          msgDiv.classList.add("message-error");
        }
      }
    }


    // === CARRITO: L√çNEAS DEL PRESUPUESTO ===

    function pintarTablaLineas() {
      const tabla = document.getElementById("tabla_lineas");
      if (!tabla) return;
      const tbody = tabla.querySelector("tbody");
      if (!tbody) return;

      if (!lineasCarrito || lineasCarrito.length === 0) {
        tbody.innerHTML = "<tr><td colspan='3'>No hay materiales a√±adidos.</td></tr>";
        return;
      }

      let html = "";
      lineasCarrito.forEach((l, idx) => {
        html += "<tr>" +
          "<td>" + (l.nombreProducto || "") + "</td>" +
          "<td>" + l.cantidad + "</td>" +
          "<td><button class='btn-ghost' type='button' onclick=\"eliminarLinea(" + idx + ")\">Eliminar</button></td>" +
          "</tr>";
      });
      tbody.innerHTML = html;
    }

    function agregarLinea() {
      if (!usuarioActual) return;
      const sel = document.getElementById("sel_producto");
      const inputCant = document.getElementById("prod_cantidad");
      const msgDiv = document.getElementById("msgGuardar");

      if (!sel || !inputCant) return;

      if (msgDiv) {
        msgDiv.textContent = "";
        msgDiv.className = "message";
      }

      const idProd = sel.value;
      if (!idProd) {
        if (msgDiv) {
          msgDiv.textContent = "Selecciona un producto antes de a√±adir.";
          msgDiv.classList.add("message-error");
        }
        return;
      }

      let cantidad = Number(inputCant.value);
      if (!cantidad || cantidad <= 0) {
        if (msgDiv) {
          msgDiv.textContent = "La cantidad debe ser mayor que 0.";
          msgDiv.classList.add("message-error");
        }
        return;
      }

      const prod = (productosCache || []).find(p => String(p.id) === String(idProd));
      if (!prod) {
        if (msgDiv) {
          msgDiv.textContent = "No se ha encontrado el producto seleccionado.";
          msgDiv.classList.add("message-error");
        }
        return;
      }

      const existente = lineasCarrito.find(l => String(l.idProducto) === String(idProd));
      if (existente) {
        existente.cantidad += cantidad;
      } else {
        lineasCarrito.push({
          idProducto: idProd,
          nombreProducto: prod.nombre,
          cantidad: cantidad
        });
      }

      
      const textoSel = document.getElementById("sel_producto_texto");
      if (textoSel) {
        textoSel.textContent = "Ning√∫n material seleccionado";
      }
inputCant.value = "1";
      pintarTablaLineas();
    }

    function eliminarLinea(idx) {
      if (idx < 0 || idx >= lineasCarrito.length) return;
      lineasCarrito.splice(idx, 1);
      pintarTablaLineas();
    }


    // === EDICI√ìN / BORRADO DE PRESUPUESTOS ===

    async function editarPresupuesto(idPresupuesto) {
      if (!usuarioActual) return;
      try {
        const datos = await apiCall("getPresupuestoEdicion", {
          email: usuarioActual.email,
          password: usuarioActual.password,
          idPresupuesto: idPresupuesto
        });

        presupuestoEnEdicionId = datos.idPresupuesto;

        const campoNombre = document.getElementById("pres_nombre");
        const campoHonor = document.getElementById("pres_honor");
        if (campoNombre) campoNombre.value = datos.nombre || "";
        if (campoHonor) campoHonor.value = datos.honorarios || "";

        lineasCarrito = (datos.lineas || []).map(l => ({
          idProducto: l.idProducto,
          nombreProducto: l.nombreProducto,
          cantidad: l.cantidad
        }));
        pintarTablaLineas();

        // Aseguramos que la secci√≥n de nuevo presupuesto est√© visible y desplegada
        const zona = document.getElementById("zonaCirujano");
        if (zona) zona.classList.remove("oculto");
        const body = document.getElementById("body-zonaCirujano");
        const arrow = document.getElementById("arrow-zonaCirujano");
        if (body && (body.style.display === "" || body.style.display === "none")) {
          body.style.display = "block";
          if (arrow) arrow.textContent = "‚ñ≤";
        }

        const msgDiv = document.getElementById("msgGuardar");
        if (msgDiv) {
          msgDiv.textContent = "Editando presupuesto ID " + datos.idPresupuesto + ". Al guardar se actualizar√° en lugar de crear uno nuevo.";
          msgDiv.className = "message";
        }
      } catch (err) {
        hideLoading();
        alert("No se ha podido cargar el presupuesto para edici√≥n: " + err.message);
      }
    }

    async function borrarPresupuesto(idPresupuesto) {
      if (!usuarioActual) return;
      const confirmar = window.confirm("¬øSeguro que quieres borrar este presupuesto? Esta acci√≥n no se puede deshacer.");
      if (!confirmar) return;

      try {
        await apiCall("borrarPresupuesto", {
          email: usuarioActual.email,
          password: usuarioActual.password,
          idPresupuesto: idPresupuesto
        });

        // Si justo est√°bamos editando este presupuesto, reseteamos el formulario
        if (presupuestoEnEdicionId && String(presupuestoEnEdicionId) === String(idPresupuesto)) {
          presupuestoEnEdicionId = null;
          lineasCarrito = [];
          pintarTablaLineas();
          const campoNombre = document.getElementById("pres_nombre");
          const campoHonor = document.getElementById("pres_honor");
          if (campoNombre) campoNombre.value = "";
          if (campoHonor) campoHonor.value = "";
          const msgDiv = document.getElementById("msgGuardar");
          if (msgDiv) {
            msgDiv.textContent = "";
            msgDiv.className = "message";
          }
        }

        // Refrescamos las vistas relevantes
        cargarMisPresupuestos();
        if (usuarioActual.rol === "ADMIN") {
          buscarPresupuestosAdmin();
        }
      } catch (err) {
        hideLoading();
        alert("No se ha podido borrar el presupuesto: " + err.message);
      }
    }

// === MIS PRESUPUESTOS ===


        async function cargarMisPresupuestos() {
      if (!usuarioActual) return;
      try {
        const lista = await apiCall("getMisPresupuestos", {
          email: usuarioActual.email,
          password: usuarioActual.password
        });
        const cont = document.getElementById("listaMisPresupuestos");
        if (!lista || lista.length === 0) {
          cont.textContent = "A√∫n no tienes presupuestos.";
          return;
        }
        let html = "<table><thead><tr>" +
          "<th>ID</th><th>Nombre</th><th>Honorarios</th><th>Fecha</th><th>Estado</th><th>Acciones</th>" +
          "</tr></thead><tbody>";
        lista.forEach(p => {
          const estado = (p.estado || "").toString().toUpperCase();
          const puedeEditarOBorrar = (estado === "BORRADOR");
          let acciones = "";
          if (puedeEditarOBorrar) {
            acciones += "<button class='btn-ghost' type='button' onclick=\"editarPresupuesto('" + p.idPresupuesto + "')\">Modificar</button>";
            acciones += " ";
            acciones += "<button class='btn-ghost' type='button' onclick=\"borrarPresupuesto('" + p.idPresupuesto + "')\">Borrar</button>";
          } else {
            acciones = "<span class='texto-secundario'>‚Äî</span>";
          }
          html += "<tr>" +
            "<td>" + p.idPresupuesto + "</td>" +
            "<td>" + p.nombre + "</td>" +
            "<td>" + p.honorarios + "</td>" +
            "<td>" + p.fecha + "</td>" +
            "<td>" + p.estado + "</td>" +
            "<td>" + acciones + "</td>" +
            "</tr>";
        });
        html += "</tbody></table>";
        cont.innerHTML = html;
      } catch (err) {
        hideLoading();
        document.getElementById("listaMisPresupuestos").textContent =
          "Error cargando tus presupuestos: " + err.message;
      }
    }


    // === VISTA ADMIN ===


    
    async function confirmarPresupuestoDesdeDialogo(idPresupuesto) {
      if (!usuarioActual) return;
      try {
        await apiCall("confirmarPresupuesto", {
          email: usuarioActual.email,
          password: usuarioActual.password,
          idPresupuesto: idPresupuesto
        });
        // Volvemos a lanzar la b√∫squeda con el filtro actual para refrescar estados
        await buscarPresupuestosAdmin();
        cerrarDialogoPresupuesto();
      } catch (err) {
        hideLoading();
        alert("No se ha podido confirmar el presupuesto: " + err.message);
      }
    }


async function verTodosBorradoresAdmin() {
      if (!usuarioActual) return;

      const cont = document.getElementById("listaPresupuestosAdmin");
      if (cont) {
        cont.textContent = "Buscando borradores...";
      }

      try {
        const lista = await apiCall("getPresupuestosAdmin", {
          email: usuarioActual.email,
          password: usuarioActual.password
        });
        listaPresupuestosAdminCache = lista || [];
        const soloBorradores = listaPresupuestosAdminCache.filter(p => {
          const est = (p.estado || "").toString().toUpperCase();
          return est === "BORRADOR";
        });
        renderPresupuestosAdmin(soloBorradores);
      } catch (err) {
        if (cont) {
          cont.textContent = "Error cargando borradores: " + err.message;
        }
      }
    }

async function buscarPresupuestosAdmin() {
      if (!usuarioActual) return;

      const input = document.getElementById("admin_filtro_cirujano");
      const filtroRaw = input ? input.value : "";
      const filtroNorm = normalizarTexto(filtroRaw);

      const cont = document.getElementById("listaPresupuestosAdmin");
      if (cont) {
        cont.textContent = "Buscando presupuestos...";
      }

      try {
        const lista = await apiCall("getPresupuestosAdmin", {
          email: usuarioActual.email,
          password: usuarioActual.password
        });
        listaPresupuestosAdminCache = lista || [];

        let listaMostrar = listaPresupuestosAdminCache;
        if (filtroNorm) {
          listaMostrar = listaPresupuestosAdminCache.filter(p => {
            const nombreCir = normalizarTexto(p.nombreCirujano || "");
            const emailCir = normalizarTexto(p.emailCirujano || "");
            return nombreCir.includes(filtroNorm) || emailCir.includes(filtroNorm);
          });
        }

        renderPresupuestosAdmin(listaMostrar);
      } catch (err) {
        hideLoading();
        if (cont) {
          cont.textContent = "Error cargando presupuestos: " + err.message;
        }
      }
    }

    
    
        function renderPresupuestosAdmin(lista) {
      const cont = document.getElementById("listaPresupuestosAdmin");
      if (!cont) return;
      if (!lista || lista.length === 0) {
        cont.textContent = "No se han encontrado presupuestos para ese criterio.";
        return;
      }
      let html = "<div class=\"tabla-scroll\"><table><thead><tr>" +
        "<th>Estado</th><th>ID</th><th>Cirujano</th><th>Nombre presupuesto</th><th>Honorarios</th>" +
        "<th>Coste materiales</th><th>Total</th><th>Fecha</th><th>Acciones</th>" +
        "</tr></thead><tbody>";
      lista.forEach(p => {
        const nombreCir = p.nombreCirujano || p.emailCirujano || "";
        const emailCir = p.emailCirujano || "";
        const estado = (p.estado || "");
        const estadoNorm = estado.toString().toUpperCase();
        let claseEstado = "";
        if (estadoNorm === "BORRADOR") claseEstado = "estado-borrador";
        else if (estadoNorm === "CONFIRMADO") claseEstado = "estado-confirmado";

        const estadoHtml = estado
          ? "<span class=\"" + (claseEstado || "") + "\">" + estado + "</span>"
          : "";

        const puedeEditarOBorrar = (estadoNorm === "BORRADOR");
        let acciones = "";
        if (puedeEditarOBorrar) {
          acciones += "<button class='btn-ghost' type='button' onclick=\"editarPresupuesto('" + p.idPresupuesto + "')\">Modificar</button>";
          acciones += " ";
          acciones += "<button class='btn-ghost' type='button' onclick=\"borrarPresupuesto('" + p.idPresupuesto + "')\">Borrar</button>";
        } else {
          acciones = "<span class='texto-secundario'>‚Äî</span>";
        }

        html += "<tr>" +
          "<td onclick=\"abrirDialogoPresupuesto('" + p.idPresupuesto + "')\" style=\"cursor:pointer;\">" + estadoHtml + "</td>" +
          "<td>" + p.idPresupuesto + "</td>" +
          "<td>" + nombreCir + (emailCir ? "<br><span class=\"texto-secundario\">" + emailCir + "</span>" : "") + "</td>" +
          "<td>" + (p.nombre || "") + "</td>" +
          "<td>" + (p.honorarios || 0) + "</td>" +
          "<td>" + (p.costeMateriales != null ? p.costeMateriales.toFixed(2) : "") + "</td>" +
          "<td>" + (p.total != null ? p.total.toFixed(2) : "") + "</td>" +
          "<td>" + (p.fecha || "") + "</td>" +
          "<td>" + acciones + "</td>" +
          "</tr>";
      });
      html += "</tbody></table></div>";
      cont.innerHTML = html;
    }


function resetFiltroPresupuestosAdmin() {
      const input = document.getElementById("admin_filtro_cirujano");
      if (input) input.value = "";
      const cont = document.getElementById("listaPresupuestosAdmin");
      if (cont) {
        cont.textContent = "Introduce un nombre o email de cirujano y pulsa Buscar.";
      }
      listaPresupuestosAdminCache = [];
    }



    function abrirDialogoPresupuesto(idPresupuesto) {
      const overlay = document.getElementById("dialogPresupuestoOverlay");
      const cont = document.getElementById("dialogPresupuestoContenido");
      if (!overlay || !cont) return;
      const p = (listaPresupuestosAdminCache || []).find(x => String(x.idPresupuesto) === String(idPresupuesto));
      if (!p) return;

      const nombreCir = p.nombreCirujano || p.emailCirujano || "";
      const emailCir = p.emailCirujano || "";
      const lineas = p.lineas || [];
      const estado = (p.estado || "");
      const estadoNorm = estado.toString().toUpperCase();

      let resumenHtml = "<div class='dialog-summary-grid'>";
      resumenHtml += "<div><div class='dialog-summary-item-label'>Cirujano</div><div class='dialog-summary-item-value'>" +
        nombreCir + (emailCir ? " <span class='texto-secundario'>(" + emailCir + ")</span>" : "") +
        "</div></div>";
      resumenHtml += "<div><div class='dialog-summary-item-label'>Presupuesto</div><div class='dialog-summary-item-value'>" +
        (p.nombre || "") + "</div></div>";
      resumenHtml += "<div><div class='dialog-summary-item-label'>Honorarios</div><div class='dialog-summary-item-value'>" +
        (p.honorarios || 0) + " ‚Ç¨</div></div>";
      resumenHtml += "<div><div class='dialog-summary-item-label'>Coste materiales</div><div class='dialog-summary-item-value'>" +
        (p.costeMateriales != null ? p.costeMateriales.toFixed(2) : "0.00") + " ‚Ç¨</div></div>";
      resumenHtml += "<div><div class='dialog-summary-item-label'>Total</div><div class='dialog-summary-item-value'>" +
        (p.total != null ? p.total.toFixed(2) : "0.00") + " ‚Ç¨</div></div>";
      resumenHtml += "<div><div class='dialog-summary-item-label'>Estado</div><div class='dialog-summary-item-value'>" +
        estado + "</div></div>";
      resumenHtml += "</div>";

      let accionesHtml = "";
      if (usuarioActual && usuarioActual.rol === "ADMIN" && estadoNorm === "BORRADOR") {
        accionesHtml = "<div class='dialog-actions-inline'>" +
          "<button class='btn-primary' type='button' onclick=\"confirmarPresupuestoDesdeDialogo('" + p.idPresupuesto + "')\">Confirmar presupuesto</button>" +
          "</div>";
      }

      let tablaHtml = "";
      if (lineas.length > 0) {
        tablaHtml += "<table><thead><tr>" +
          "<th>Producto</th><th>Cantidad</th><th>Coste unitario</th><th>Subtotal</th>" +
          "</tr></thead><tbody>";
        lineas.forEach(l => {
          tablaHtml += "<tr>" +
            "<td>" + (l.nombreProducto || "") + "</td>" +
            "<td>" + (l.cantidad || 0) + "</td>" +
            "<td>" + (l.costeUnitario != null ? l.costeUnitario.toFixed(2) : "") + "</td>" +
            "<td>" + (l.subtotal != null ? l.subtotal.toFixed(2) : "") + "</td>" +
            "</tr>";
        });
        tablaHtml += "</tbody></table>";
      } else {
        tablaHtml += "<p style='font-size:0.8rem;color:#6b7280;'>Este presupuesto no tiene materiales registrados.</p>";
      }

      cont.innerHTML = resumenHtml + accionesHtml + tablaHtml;
      overlay.classList.add("activo");
    }


    function cerrarDialogoPresupuesto() {
      const overlay = document.getElementById("dialogPresupuestoOverlay");
      if (overlay) overlay.classList.remove("activo");
    }

  

  </script>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner-box">
      <div class="spinner"></div>
      Procesando...
    </div>
  </div>

</body>
</html>
